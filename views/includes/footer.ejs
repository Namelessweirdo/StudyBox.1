<!-- include necessary JS files -->
<script src="<%= request.mainURL %>/public/js/jquery-3.3.1.min.js"></script>
<script src="<%= request.mainURL %>/public/js/popper.min.js"></script>
<script src="<%= request.mainURL %>/public/js/bootstrap.min.js"></script>
<script src="<%= request.mainURL %>/public/js/sweetalert.min.js"></script>

<script>
    function confirmDeleteFile(form) {
        swal({
            title: "Are you sure?",
            text: "Once deleted, you will not be able to recover this file!",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
            .then(function(willDelete) {
                if (willDelete) {
                    document.getElementById("form-delete-file").submit();
                }
            });
    }

    // send the request to server to download the file
    function downloadFile(self) {
        var _id = self.getAttribute("data-id");

        self.innerHTML = "Loading...";
        self.setAttribute("disabled", "disabled");

        var ajax = new XMLHttpRequest();
        ajax.open("POST", document.getElementById("base-url").value + "/DownloadFile", true);

        ajax.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var data = JSON.parse(this.responseText);
                if (data.status === "success") {
                    var binary = '';
                    var bytes = new Uint8Array(data.arrayBuffer.data);
                    for (var i = 0; i < bytes.byteLength; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    var base64 = window.btoa(binary);
                    const link = document.createElement('a');
                    link.href = "data:" + data.fileType + ";base64," + base64;
                    link.download = data.fileName;
                    link.click();
                } else {
                    swal("Error", data.message, "error");
                }
                self.innerHTML = "Download";
                self.removeAttribute("disabled");
            } else if (this.status !== 200) {
                swal("Error", "An error occurred. Please try again.", "error");
            }
        };

        var formData = new FormData();
        formData.append("_id", _id);
        ajax.send(formData);
    }
</script>

</body>
</html>